# ğŸ“ Cáº¤U TRÃšC Dá»° ÃN - AUTO REGISTRATION

## ğŸ¯ Overview

Dá»± Ã¡n sá»­ dá»¥ng **auto-registration architecture** - agent tá»± Ä‘á»™ng Ä‘Äƒng kÃ½ vá»›i backend khi cháº¡y láº§n Ä‘áº§u.

---

## ğŸ“‚ Root Structure

```
baseline-monitor/
â”œâ”€â”€ agent/              # ğŸ¤– Agent code (cháº¡y trÃªn client machines)
â”œâ”€â”€ backend/            # ğŸ”§ Backend API server (FastAPI + PostgreSQL)
â”œâ”€â”€ frontend/           # ğŸ–¥ï¸ Dashboard UI (React + Vite)
â”œâ”€â”€ docs/               # ğŸ“š Documentation
â”œâ”€â”€ infra/              # ğŸ³ Infrastructure (Docker, deployment)
â”œâ”€â”€ scripts/            # ğŸ› ï¸ Utility scripts
â”œâ”€â”€ logs/               # ğŸ“‹ Runtime logs (gitignored)
â”œâ”€â”€ config.yaml         # âš™ï¸ Agent config (gitignored, auto-generated)
â”œâ”€â”€ .agent_cache.json   # ğŸ’¾ Runtime cache (gitignored, auto-generated)
â””â”€â”€ README.md
```

---

## ğŸ¤– Agent Folder (`agent/`)

```
agent/
â”œâ”€â”€ common/                           # Shared modules
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                     # Load config + cache (agent_id)
â”‚   â”œâ”€â”€ http_client.py                # API client with retry logic
â”‚   â”œâ”€â”€ logger.py                     # Rotating file logger
â”‚   â”œâ”€â”€ models.py                     # Pydantic data models
â”‚   â””â”€â”€ system_info.py                # Collect machine info (hostname, IP, OS, MAC)
â”‚
â”œâ”€â”€ linux/                            # Linux-specific implementation
â”‚   â””â”€â”€ main.py                       # Main agent runner (auto-registration)
â”‚
â”œâ”€â”€ rules/                            # CIS compliance rules
â”‚   â”œâ”€â”€ ubuntu_rules.json             # Ubuntu CIS Benchmark rules
â”‚   â””â”€â”€ windows_rules.json            # Windows CIS Benchmark rules
â”‚
â””â”€â”€ setup.py                          # ğŸŒŸ Setup wizard (auto-generate config)
```

### Key Files Explained:

| File | Purpose | Auto-generated? |
|------|---------|-----------------|
| `setup.py` | Setup wizard - táº¡o `config.yaml` | âŒ Code file |
| `common/config.py` | Load config + cache agent_id | âŒ Code file |
| `common/system_info.py` | Thu tháº­p hostname, IP, OS, MAC | âŒ Code file |
| `linux/main.py` | Main agent runner, auto-register | âŒ Code file |

---

## ğŸ”§ Backend Folder (`backend/`)

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/                         # Core config (settings, database)
â”‚   â”œâ”€â”€ modules/                      # Feature modules
â”‚   â”‚   â”œâ”€â”€ agents/                   # Agent management (UPSERT logic)
â”‚   â”‚   â”œâ”€â”€ auth/                     # Authentication (JWT)
â”‚   â”‚   â”œâ”€â”€ rules/                    # CIS rules management
â”‚   â”‚   â””â”€â”€ violations/               # Violation tracking
â”‚   â”œâ”€â”€ main.py                       # FastAPI app entry point
â”‚   â””â”€â”€ ...
â”œâ”€â”€ alembic/                          # Database migrations
â”œâ”€â”€ requirements.txt                  # Python dependencies
â””â”€â”€ venv/                             # Virtual environment (gitignored)
```

---

## ğŸ–¥ï¸ Frontend Folder (`frontend/`)

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/                   # React components
â”‚   â”œâ”€â”€ pages/                        # Page views
â”‚   â”œâ”€â”€ App.jsx                       # Main app
â”‚   â””â”€â”€ main.jsx                      # Entry point
â”œâ”€â”€ public/                           # Static assets
â”œâ”€â”€ package.json                      # npm dependencies
â””â”€â”€ node_modules/                     # npm packages (gitignored)
```

---

## ğŸ“š Docs Folder (`docs/`)

```
docs/
â”œâ”€â”€ AUTO_REGISTRATION_DETAIL.md       # Auto-registration technical deep-dive
â”œâ”€â”€ LUONG_AGENT_CHI_TIET.md           # Vietnamese detailed flow explanation
â”œâ”€â”€ QUICK_START.md                    # Quick start guide (3 ways to setup)
â”œâ”€â”€ PROJECT_STRUCTURE.md              # This file
â””â”€â”€ selected_rules.md                 # CIS rules selection
```

---

## ğŸ› ï¸ Scripts Folder (`scripts/`)

```
scripts/
â””â”€â”€ test_auto_registration.sh         # Test script for auto-registration flow
```

**Removed:**
- ~~`bootstrap_agent.sh`~~ - Replaced by `agent/setup.py` wizard

---

## âš™ï¸ Runtime Files (Gitignored)

These files are **auto-generated** and should NOT be committed:

### 1. `config.yaml`
- **Táº¡o bá»Ÿi:** `python3 agent/setup.py`
- **Chá»©a:** Backend URL, hostname, OS type, scan settings
- **Äáº·c Ä‘iá»ƒm:** Machine-specific (má»—i mÃ¡y khÃ¡c nhau)

**Example:**
```yaml
# Generated by Agent Setup Wizard
# Date: 2025-11-17 15:05:22
# Hostname: web-server-01

backend:
  api_url: http://backend:8000
agent:
  hostname: web-server-01
  os_type: ubuntu
scanner:
  scan_interval: 3600
  rules_path: ./agent/rules/ubuntu_rules.json
logging:
  level: INFO
  log_file: ./logs/agent.log
```

---

### 2. `.agent_cache.json`
- **Táº¡o bá»Ÿi:** `agent/linux/main.py` (after first registration)
- **Chá»©a:** `agent_id` tá»« backend
- **Äáº·c Ä‘iá»ƒm:** Runtime cache, 1 dÃ²ng JSON

**Example:**
```json
{"agent_id": 7}
```

---

### 3. `config.yaml.backup`
- **Táº¡o bá»Ÿi:** `agent/setup.py` (khi overwrite config cÅ©)
- **Chá»©a:** Backup cá»§a `config.yaml` trÆ°á»›c Ä‘Ã³
- **Äáº·c Ä‘iá»ƒm:** Safety backup

---

### 4. `logs/`
- **Táº¡o bá»Ÿi:** Agent khi cháº¡y
- **Chá»©a:** `agent.log`, `agent.log.1`, `agent.log.2`, ... (rotate)
- **Äáº·c Ä‘iá»ƒm:** Rotating logs (max 10MB, keep 5 files)

---

## ğŸ—‘ï¸ Removed Files/Folders

CÃ¡c file/folder sau Ä‘Ã£ bá»‹ xÃ³a do khÃ´ng cáº§n thiáº¿t vá»›i auto-registration:

| File/Folder | LÃ½ do xÃ³a |
|-------------|-----------|
| `agent/config.example.yaml` | âŒ Thay tháº¿ bá»Ÿi `setup.py` wizard |
| `agent/window/` | âŒ Folder rá»—ng (sáº½ implement láº¡i sau) |
| `scripts/bootstrap_agent.sh` | âŒ `setup.py` wizard tá»‘t hÆ¡n vÃ  linh hoáº¡t hÆ¡n |

---

## ğŸš€ Deployment Workflow

### First Time Setup (Per Machine)

```bash
# 1. Run setup wizard
python3 agent/setup.py --backend-url http://backend:8000 --no-interactive

# Files created:
#   âœ… config.yaml (machine-specific)

# 2. Start agent
python3 agent/linux/main.py

# Files created:
#   âœ… .agent_cache.json (after registration)
#   âœ… logs/agent.log (runtime logs)
```

---

## ğŸ“Š File Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEVELOPMENT (Git-tracked)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  agent/setup.py          â† Code                 â”‚
â”‚  agent/common/*.py       â† Code                 â”‚
â”‚  agent/linux/main.py     â† Code                 â”‚
â”‚  agent/rules/*.json      â† Data                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         python3 agent/setup.py
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RUNTIME (Gitignored)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  config.yaml             â† Auto-generated       â”‚
â”‚  config.yaml.backup      â† Auto-backup          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         python3 agent/linux/main.py
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RUNTIME (Gitignored)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  .agent_cache.json       â† After registration   â”‚
â”‚  logs/agent.log          â† Runtime logs         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Checklist: What to Commit?

**âœ… COMMIT:**
- `agent/*.py` - Code files
- `agent/common/*.py` - Shared modules
- `agent/linux/main.py` - Agent runner
- `agent/rules/*.json` - CIS rules
- `backend/` - Backend code
- `frontend/` - Frontend code
- `docs/` - Documentation
- `README.md` - Project readme

**âŒ DON'T COMMIT:**
- `config.yaml` - Machine-specific
- `config.yaml.backup` - Backup file
- `.agent_cache.json` - Runtime cache
- `logs/` - Runtime logs
- `venv/` - Virtual environment
- `node_modules/` - npm packages
- `__pycache__/` - Python cache

---

## ğŸ” Quick Reference

**Setup new machine:**
```bash
python3 agent/setup.py --backend-url <URL> --no-interactive
```

**Run agent:**
```bash
python3 agent/linux/main.py
```

**Check config:**
```bash
cat config.yaml
```

**Check cache:**
```bash
cat .agent_cache.json
```

**View logs:**
```bash
tail -f logs/agent.log
```

**Reset agent (fresh start):**
```bash
rm config.yaml .agent_cache.json
python3 agent/setup.py
```

---

**ğŸ‰ Cáº¥u trÃºc sáº¡ch sáº½, dá»… hiá»ƒu, dá»… deploy!**
